<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ ì•Œë¦¬ë¯¸ Â· ê´€ë¦¬ì</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #080810;
            --surface: #0F0F1A;
            --surface2: #16162A;
            --border: rgba(255,255,255,0.07);
            --text: #EEEEF8;
            --text2: #7777AA;
            --text3: #44445A;
            --accent: #7B6FFF;
            --accent2: #FF6B9D;
            --green: #00E5A0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* í—¤ë” */
        .header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--surface);
            flex-shrink: 0;
        }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .logo {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
        }
        .header-title { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; }
        .header-sub { font-size: 11px; color: var(--text3); margin-top: 1px; }
        .status-dot {
            width: 8px; height: 8px;
            background: var(--green);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--green);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* ì„¤ì • íŒ¨ë„ */
        .config-bar {
            padding: 12px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 12px;
            align-items: center;
            background: var(--surface);
            flex-shrink: 0;
            overflow-x: auto;
        }
        .config-label { font-size: 11px; color: var(--text3); white-space: nowrap; }
        .config-input {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 12px;
            color: var(--text);
            font-size: 12px;
            font-family: 'DM Sans', sans-serif;
            outline: none;
            min-width: 200px;
        }
        .config-input:focus { border-color: var(--accent); }
        .config-input::placeholder { color: var(--text3); }
        .config-btn {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            border: none;
            border-radius: 8px;
            padding: 7px 16px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            white-space: nowrap;
            transition: opacity 0.2s;
        }
        .config-btn:hover { opacity: 0.85; }

        /* ë¹ ë¥¸ ëª…ë ¹ì–´ */
        .quick-bar {
            padding: 10px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            overflow-x: auto;
        }
        .quick-btn {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 5px 14px;
            color: var(--text2);
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            font-family: 'DM Sans', sans-serif;
        }
        .quick-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(123,111,255,0.08);
        }

        /* ì±„íŒ… ì˜ì—­ */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .chat-area::-webkit-scrollbar { width: 4px; }
        .chat-area::-webkit-scrollbar-track { background: transparent; }
        .chat-area::-webkit-scrollbar-thumb { background: var(--text3); border-radius: 2px; }

        /* ë©”ì‹œì§€ */
        .msg { display: flex; gap: 12px; max-width: 80%; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .msg.user { align-self: flex-end; flex-direction: row-reverse; }
        .msg-avatar {
            width: 32px; height: 32px;
            border-radius: 10px;
            flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 15px;
        }
        .msg.assistant .msg-avatar { background: linear-gradient(135deg, var(--accent), var(--accent2)); }
        .msg.user .msg-avatar { background: var(--surface2); border: 1px solid var(--border); }
        .msg-bubble {
            padding: 12px 16px;
            border-radius: 14px;
            font-size: 14px;
            line-height: 1.6;
        }
        .msg.assistant .msg-bubble {
            background: var(--surface);
            border: 1px solid var(--border);
            border-top-left-radius: 4px;
        }
        .msg.user .msg-bubble {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: white;
            border-top-right-radius: 4px;
        }
        .msg-status {
            font-size: 11px;
            color: var(--text3);
            margin-top: 4px;
            padding: 0 4px;
        }
        .msg.user .msg-status { text-align: right; }

        /* ì½”ë“œ ë¸”ë¡ */
        .code-block {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--green);
            overflow-x: auto;
            white-space: pre-wrap;
        }

        /* ê²°ê³¼ ì¹´ë“œ */
        .result-card {
            background: rgba(0,229,160,0.06);
            border: 1px solid rgba(0,229,160,0.2);
            border-radius: 10px;
            padding: 12px 14px;
            margin-top: 8px;
            font-size: 13px;
            color: var(--green);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .result-card.error {
            background: rgba(255,77,77,0.06);
            border-color: rgba(255,77,77,0.2);
            color: #FF6B6B;
        }

        /* ë¡œë”© */
        .loading {
            display: flex;
            gap: 4px;
            padding: 4px 0;
        }
        .loading span {
            width: 6px; height: 6px;
            background: var(--accent);
            border-radius: 50%;
            animation: bounce 1.2s infinite;
        }
        .loading span:nth-child(2) { animation-delay: 0.2s; }
        .loading span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); opacity: 0.4; }
            40% { transform: translateY(-6px); opacity: 1; }
        }

        /* ì…ë ¥ì°½ */
        .input-area {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            background: var(--surface);
            flex-shrink: 0;
        }
        .input-wrap {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 10px 14px;
            transition: border-color 0.2s;
        }
        .input-wrap:focus-within { border-color: var(--accent); }
        #userInput {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: var(--text);
            font-size: 14px;
            font-family: 'DM Sans', sans-serif;
            resize: none;
            max-height: 120px;
            line-height: 1.5;
        }
        #userInput::placeholder { color: var(--text3); }
        .send-btn {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            transition: opacity 0.2s, transform 0.1s;
        }
        .send-btn:hover { opacity: 0.85; }
        .send-btn:active { transform: scale(0.95); }
        .send-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .input-hint { font-size: 11px; color: var(--text3); margin-top: 8px; text-align: center; }

        /* í™˜ì˜ ë©”ì‹œì§€ */
        .welcome {
            text-align: center;
            padding: 40px 20px;
            color: var(--text3);
        }
        .welcome-icon { font-size: 40px; margin-bottom: 12px; }
        .welcome h2 { font-family: 'Syne', sans-serif; font-size: 20px; color: var(--text2); margin-bottom: 8px; }
        .welcome p { font-size: 13px; line-height: 1.6; }
    </style>
</head>
<body>

<div class="header">
    <div class="header-left">
        <div class="logo">ğŸ“Š</div>
        <div>
            <div class="header-title">ì£¼ì‹ ì•Œë¦¬ë¯¸ ê´€ë¦¬ì</div>
            <div class="header-sub">AIë¡œ í˜ì´ì§€ë¥¼ ë°”ë¡œ ìˆ˜ì •í•˜ì„¸ìš”</div>
        </div>
    </div>
    <div class="status-dot"></div>
</div>

<div class="config-bar">
    <span class="config-label">Anthropic API Key</span>
    <input type="password" class="config-input" id="apiKey" placeholder="sk-ant-..." style="min-width:280px">
    <span class="config-label">GitHub Token</span>
    <input type="password" class="config-input" id="githubToken" placeholder="ghp_..." style="min-width:200px">
    <button class="config-btn" onclick="saveConfig()">ğŸ’¾ ì €ì¥</button>
    <button class="config-btn" style="background:linear-gradient(135deg,#00C896,#00A8FF)" onclick="triggerDeploy()">ğŸš€ ì¦‰ì‹œ ë°°í¬</button>
</div>

<div class="quick-bar">
    <span style="font-size:11px;color:var(--text3);margin-right:4px">ë¹ ë¥¸ ëª…ë ¹</span>
    <button class="quick-btn" onclick="quickCmd('ì‚¼ì„±ì „ì ì¢…ëª©ì„ ì¶”ê°€í•´ì¤˜')">+ ì‚¼ì„±ì „ì ì¶”ê°€</button>
    <button class="quick-btn" onclick="quickCmd('í˜„ì¬ ë“±ë¡ëœ ì¢…ëª© ëª©ë¡ì„ ì•Œë ¤ì¤˜')">ì¢…ëª© ëª©ë¡ í™•ì¸</button>
    <button class="quick-btn" onclick="quickCmd('ë¦¬í¬íŠ¸ ë°°ê²½ì„ í™”ì´íŠ¸ í…Œë§ˆë¡œ ë°”ê¿”ì¤˜')">â˜€ï¸ í™”ì´íŠ¸ í…Œë§ˆ</button>
    <button class="quick-btn" onclick="quickCmd('ë¦¬í¬íŠ¸ ë°°ê²½ì„ ë‹¤í¬ í…Œë§ˆë¡œ ë°”ê¿”ì¤˜')">ğŸŒ™ ë‹¤í¬ í…Œë§ˆ</button>
    <button class="quick-btn" onclick="quickCmd('ì¹´ì¹´ì˜¤í†¡ ë°œì†¡ ì‹œê°„ì„ ì˜¤ì „ 8ì‹œë¡œ ë°”ê¿”ì¤˜')">â° ë°œì†¡ ì‹œê°„ ë³€ê²½</button>
    <button class="quick-btn" onclick="quickCmd('ë¦¬í¬íŠ¸ ë¶„ì„ì„ ë” ê°„ê²°í•˜ê²Œ ë°”ê¿”ì¤˜')">âœ‚ï¸ ë¦¬í¬íŠ¸ ê°„ê²°í•˜ê²Œ</button>
</div>

<div class="chat-area" id="chatArea">
    <div class="welcome">
        <div class="welcome-icon">ğŸ¤–</div>
        <h2>ë¬´ì—‡ì„ ìˆ˜ì •í• ê¹Œìš”?</h2>
        <p>ë§ë¡œ ìš”ì²­í•˜ë©´ stock_report.py ì½”ë“œë¥¼ ìë™ìœ¼ë¡œ ìˆ˜ì •í•˜ê³ <br>GitHubì— ë°”ë¡œ ë°˜ì˜í•´ë“œë ¤ìš”</p>
    </div>
</div>

<div class="input-area">
    <div class="input-wrap">
        <textarea id="userInput" placeholder="ì˜ˆ: ì• í”Œ ì¢…ëª©ì„ ì‚­ì œí•˜ê³  ì—”ë¹„ë””ì•„ë¥¼ ì¶”ê°€í•´ì¤˜" rows="1"
            onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">â†‘</button>
    </div>
    <div class="input-hint">Enterë¡œ ì „ì†¡ Â· Shift+Enterë¡œ ì¤„ë°”ê¿ˆ</div>
</div>

<script>
// ì„¤ì • ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
function saveConfig() {
    const key = document.getElementById('apiKey').value;
    const gh = document.getElementById('githubToken').value;
    if (key) localStorage.setItem('anthropic_key', key);
    if (gh) localStorage.setItem('github_token', gh);
    addMsg('assistant', 'âœ… API í‚¤ê°€ ì €ì¥ëì–´ìš”! ì´ì œ ëª…ë ¹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
}

window.onload = () => {
    const key = localStorage.getItem('anthropic_key');
    const gh = localStorage.getItem('github_token');
    if (key) document.getElementById('apiKey').value = key;
    if (gh) document.getElementById('githubToken').value = gh;
};

// í˜„ì¬ stock_report.py ì½”ë“œ (GitHubì—ì„œ ê°€ì ¸ì˜¤ê¸°)
const GITHUB_USER = 'insikoo';
const GITHUB_REPO = 'stock-report';

async function getFileFromGithub(path) {
    const token = localStorage.getItem('github_token');
    const res = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${path}`, {
        headers: { 'Authorization': `token ${token}` }
    });
    const data = await res.json();
    return {
        content: atob(data.content.replace(/\n/g, '')),
        sha: data.sha
    };
}

async function updateFileOnGithub(path, content, sha, message) {
    const token = localStorage.getItem('github_token');
    const res = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${path}`, {
        method: 'PUT',
        headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            message,
            content: btoa(unescape(encodeURIComponent(content))),
            sha
        })
    });
    return res.ok;
}

async function triggerDeploy() {
    const token = localStorage.getItem('github_token');
    if (!token) { addMsg('assistant', 'âŒ GitHub Tokenì„ ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”!'); return; }

    addMsg('assistant', 'ğŸš€ GitHub Actions ë°°í¬ë¥¼ ì‹œì‘í• ê²Œìš”...');
    const res = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/actions/workflows/deploy.yml/dispatches`, {
        method: 'POST',
        headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ ref: 'main' })
    });
    if (res.ok || res.status === 204) {
        addMsg('assistant', 'âœ… ë°°í¬ê°€ ì‹œì‘ëì–´ìš”! ì•½ 1~2ë¶„ í›„ í˜ì´ì§€ê°€ ì—…ë°ì´íŠ¸ë¼ìš”.\n\nğŸ‘‰ https://insikoo.github.io/stock-report/', true);
    } else {
        addMsg('assistant', 'âŒ ë°°í¬ ì‹¤íŒ¨. GitHub Token ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.', false, true);
    }
}

// ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€
function addMsg(role, text, isLink, isError) {
    const area = document.getElementById('chatArea');
    const welcome = area.querySelector('.welcome');
    if (welcome) welcome.remove();

    const msg = document.createElement('div');
    msg.className = `msg ${role}`;

    const avatar = document.createElement('div');
    avatar.className = 'msg-avatar';
    avatar.textContent = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';

    const bubble = document.createElement('div');
    bubble.className = 'msg-bubble';

    if (isError) {
        bubble.innerHTML = `<div class="result-card error">âŒ ${text}</div>`;
    } else if (text.includes('```')) {
        const parts = text.split('```');
        let html = '';
        parts.forEach((p, i) => {
            if (i % 2 === 0) html += p.replace(/\n/g, '<br>');
            else html += `<div class="code-block">${p.replace(/^python\n/, '')}</div>`;
        });
        bubble.innerHTML = html;
    } else {
        bubble.innerHTML = text.replace(/\n/g, '<br>');
    }

    const time = document.createElement('div');
    time.className = 'msg-status';
    time.textContent = new Date().toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});

    msg.appendChild(avatar);
    const wrap = document.createElement('div');
    wrap.appendChild(bubble);
    wrap.appendChild(time);
    msg.appendChild(wrap);
    area.appendChild(msg);
    area.scrollTop = area.scrollHeight;
    return msg;
}

function addLoading() {
    const area = document.getElementById('chatArea');
    const msg = document.createElement('div');
    msg.className = 'msg assistant';
    msg.id = 'loadingMsg';
    msg.innerHTML = `
        <div class="msg-avatar">ğŸ¤–</div>
        <div class="msg-bubble">
            <div class="loading"><span></span><span></span><span></span></div>
        </div>`;
    area.appendChild(msg);
    area.scrollTop = area.scrollHeight;
}

function removeLoading() {
    const el = document.getElementById('loadingMsg');
    if (el) el.remove();
}

// ë©”ì‹œì§€ ì „ì†¡
async function sendMessage() {
    const input = document.getElementById('userInput');
    const text = input.value.trim();
    if (!text) return;

    const apiKey = localStorage.getItem('anthropic_key');
    if (!apiKey) {
        addMsg('assistant', 'âŒ ìƒë‹¨ì— Anthropic API Keyë¥¼ ë¨¼ì € ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”!');
        return;
    }

    addMsg('user', text);
    input.value = '';
    input.style.height = 'auto';
    document.getElementById('sendBtn').disabled = true;
    addLoading();

    try {
        // GitHubì—ì„œ í˜„ì¬ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        let currentCode = '';
        let fileSha = '';
        try {
            const fileData = await getFileFromGithub('stock_report.py');
            currentCode = fileData.content;
            fileSha = fileData.sha;
        } catch(e) {
            currentCode = '(íŒŒì¼ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆì–´ìš”)';
        }

        // Claude API í˜¸ì¶œ
        const res = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': apiKey,
                'anthropic-version': '2023-06-01'
            },
            body: JSON.stringify({
                model: 'claude-sonnet-4-6',
                max_tokens: 4000,
                system: `ë‹¹ì‹ ì€ ì£¼ì‹ ì‹œí™© ìë™í™” ì‹œìŠ¤í…œì˜ ê´€ë¦¬ ë„ìš°ë¯¸ì…ë‹ˆë‹¤.
ì‚¬ìš©ìì˜ ìš”ì²­ì— ë”°ë¼ stock_report.py íŒŒì¼ì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”.

í˜„ì¬ stock_report.py ì½”ë“œ:
\`\`\`python
${currentCode}
\`\`\`

ê·œì¹™:
1. ì‚¬ìš©ì ìš”ì²­ì„ ë¶„ì„í•´ì„œ ì½”ë“œë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”
2. ì‘ë‹µì€ ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ í•´ì£¼ì„¸ìš”:
{
  "explanation": "ë¬´ì—‡ì„ ì–´ë–»ê²Œ ìˆ˜ì •í–ˆëŠ”ì§€ í•œêµ­ì–´ë¡œ ì„¤ëª…",
  "modified_code": "ìˆ˜ì •ëœ ì „ì²´ íŒŒì´ì¬ ì½”ë“œ",
  "should_deploy": true
}
3. modified_codeì—ëŠ” ì™„ì „í•œ íŒŒì´ì¬ ì½”ë“œ ì „ì²´ë¥¼ ë„£ì–´ì£¼ì„¸ìš”
4. JSON ì™¸ì˜ ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”`,
                messages: [{ role: 'user', content: text }]
            })
        });

        const data = await res.json();
        removeLoading();

        const rawText = data.content[0].text;

        // JSON íŒŒì‹±
        let parsed;
        try {
            const jsonMatch = rawText.match(/\{[\s\S]*\}/);
            parsed = JSON.parse(jsonMatch[0]);
        } catch(e) {
            addMsg('assistant', rawText);
            document.getElementById('sendBtn').disabled = false;
            return;
        }

        // ì„¤ëª… í‘œì‹œ
        addMsg('assistant', parsed.explanation);

        // GitHubì— ì½”ë“œ ì—…ë¡œë“œ
        if (parsed.modified_code && fileSha && parsed.should_deploy) {
            addLoading();
            const success = await updateFileOnGithub(
                'stock_report.py',
                parsed.modified_code,
                fileSha,
                `Admin update: ${text.slice(0, 50)}`
            );
            removeLoading();

            if (success) {
                const successMsg = document.createElement('div');
                successMsg.className = 'msg assistant';
                successMsg.innerHTML = `
                    <div class="msg-avatar">ğŸ¤–</div>
                    <div>
                        <div class="msg-bubble">
                            <div class="result-card">
                                âœ… GitHubì— ë°˜ì˜ ì™„ë£Œ! GitHub Actionsê°€ ìë™ ë°°í¬ ì¤‘ì´ì—ìš”.<br>
                                ì•½ 1~2ë¶„ í›„ í˜ì´ì§€ê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
                            </div>
                        </div>
                    </div>`;
                document.getElementById('chatArea').appendChild(successMsg);
                document.getElementById('chatArea').scrollTop = 999999;
            } else {
                addMsg('assistant', 'GitHub ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆì–´ìš”. Token ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.', false, true);
            }
        }

    } catch(e) {
        removeLoading();
        addMsg('assistant', `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”: ${e.message}`, false, true);
    }

    document.getElementById('sendBtn').disabled = false;
}

function quickCmd(cmd) {
    document.getElementById('userInput').value = cmd;
    sendMessage();
}

function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
}

function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}
</script>
</body>
</html>